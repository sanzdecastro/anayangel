---
import Welcome from "../components/Welcome.astro";
import Layout from "../layouts/Layout.astro";

const images = ["foto_1", "foto_2"];
const image = images[Math.floor(Math.random() * images.length)];

// Welcome to Astro! Wondering what to do next? Check out the Astro documentation at https://docs.astro.build
// Don't want to use any of this? Delete everything in this file, the `assets`, `components`, and `layouts` directories, and start fresh.
---

<Layout>
  <div class="wrapper">
    <h1 class="intro-names z-10">Ana & Ángel</h1>
    <div class="envelope-wrapper z-10">
      <div class="envelope-group">
        <img src="/sobre-close.png" class="sobre-close" />
        <img src="/sobre-open.png" class="sobre-open" />
      </div>
    </div>
    <p class="introduction-text">
      ¡Tenemos una gran noticia <br />que queremos compartir contigo!
    </p>

    <div class="image-wrapper mix-blend-multiply absolute">
      <img src="/flower1.jpg" class="flower-1" />
    </div>

    <div class="content">
      <div class="content-wrapper">
		<img src="/flower2.jpg" class="flower-2" />
        <h2 class="effect-opacity">Ana & Ángel</h2>
        <p class="effect-opacity mb-16">¡Nos casamos!</p>
        <div class="image-wrapper image-two rotate-3 mb-24">
          <img src="/pareja.jpg" />
        </div>

        <section
          class="mb-24 circle-container relative w-full h-full flex items-center aspect-square"
        >
          <img
            class="circle absolute top-0 scale-120 left-0 opacity-10 animate-[spin_10s_linear_infinite]"
            src="/rotate.svg"
          />
          <div
            class="w-full effect-opacity h-full absolute top-0 left-0 flex flex-col justify-center items-center"
          >
            <p class="!mb-0.5">18 de octubre de 2025</p>
            <div class="flex justify-center gap-2">
              <p class="!mb-0.5">13:00h</p><span class="font-Millionaire-Script"
                >Casas Viejas</span
              ><p class="!mb-0.5">Benalup</p>
            </div>
            <p class="!mb-0.5">Fairplay Golf & Spa Resort</p>
          </div>
        </section>
        <section class="mb-32 effect-opacity">
          <p>
            Estamos encantados <br />de invitarte a <span
              class="font-Millionaire-Script">nuestra boda</span
            >
          </p>
          <p>
            El próximo 18 de octubre <br /> nos gustaría <span
              class="font-Millionaire-Script">compartir contigo</span
            >
            <br />este día tan especial.
          </p>
          <p>¡Confírmanos que vienes!</p>
        </section>

        <div class="cta">Confirmar asistencia</div>
		<section class="relative">
			<img src="/flower3.jpg" class="flower-3" />
		</section>
		

        <section class="mb-32 effect-opacity">
          <h3 class="!mb-10">Lugar<br /> de celebración</h3>
          <div
            class="image-wrapper mb-10 aspect-square overflow-hidden rounded-md"
          >
            <img class="h-full" src="/spa.jpg" />
          </div>
          <div class="flex justify-center items-center flex-col gap-2 mb-5">
            <a href="https://www.fairplayresort.com/es/"
              ><span class="font-Millionaire-Script"
                >Fairplay Golf & Spa Resort</span
              ><br /> en Benalup</a
            >
            <a
              class="underline underline-offset-4"
              target="_blank"
              href="https://maps.app.goo.gl/Q2QahHd6C9pj8MVy9">Ver en el mapa</a
            >
          </div>
        </section>
		<section class="relative">
			<img src="/flower6.jpg" class="flower-6" />
		</section>
		<section class="mb-32">
			<h3 class="effect-opacity !mb-12">El plan</h3>
			<div class="effect-opacity flex flex-col gap-2 mb-4">
				<span class="font-Millionaire-Script">12:30h</span>
				<p>
					Nos reunimos en el hotel<br> para tomar un aperitivo
				</p>
			</div>
			<div class="effect-opacity flex flex-col gap-2 mb-4">
				<span class="font-Millionaire-Script">13:00h</span>
				<p>
					Celebraremos<br> la ceremonia en el jardín.
				</p>
			</div>
			<div class="effect-opacity flex flex-col gap-2 mb-4">
				<span class="font-Millionaire-Script">16:00h</span>
				<p>
					¡A comer!
				</p>
			</div>
			<div class="effect-opacity flex flex-col gap-2 mb-4">
				<span class="font-Millionaire-Script">18:00h</span>
				<p>
					Fiesta y musiquita<br> hasta que el cuerpo aguante
				</p>
			</div>
		</section>
		<section class="relative">
			<img src="/flower4.jpg" class="flower-4" />
		</section>
        <section class="mb-32">
          <h3 class="effect-opacity">¿Te quedas la noche?</h3>
          <p class="effect-opacity !mb-12">
            Te dejamos algunas opciones donde pasar la noche si lo necesitas:
          </p>
          <ul class="flex flex-col gap-2">
            <li class="flex effect-opacity gap-1.5">
              <div
                class="!w-[100px] image-wrapper aspect-square overflow-hidden rounded-md"
              >
                <img src="/utopia.jpeg" />
              </div>
              <div class="w-full flex flex-col items-start">
                <h4>Hotel Utopía</h4>
                <div class="flex flex-wrap gap-2.5">
                  <p><a href="tel:0034621123904">621 12 39 04</a></p>
                  <a href="https://hotelutopiabenalup.com/">🌐 Web</a>
                  <a target="_blank" href="https://maps.app.goo.gl/dKcX4LekJyQ168LS9">📍 Mapa</a>
                </div>
              </div>
            </li>
            <li class="flex effect-opacity gap-1.5">
              <div
                class="!w-[100px] image-wrapper aspect-square overflow-hidden rounded-md"
              >
                <img src="/golf.jpeg" />
              </div>
              <div class="w-full flex flex-col items-start">
                <h4>Hostal Restaurante Benalup Golf</h4>
                <div class="flex flex-wrap gap-2.5">
                  <p><a href="tel:0034956231903">956 23 19 03</a></p>
                  <p><a href="https://hrbenalupgolf.com/">🌐 Web</a></p>
                  <p><a target="_blank" href="https://maps.app.goo.gl/j785oqizRuiXyFAv9">📍 Mapa</a></p>
                </div>
              </div>
			</li>
              <li class="flex effect-opacity gap-1.5">
                <div
                  class="!w-[100px] image-wrapper aspect-square overflow-hidden rounded-md"
                >
                  <img src="/atalaya.jpeg" />
                </div>
                <div class="w-full flex flex-col items-start">
                  <h4>Hostal Atalaya</h4>
                  <div class="flex flex-wrap gap-2.5">
                    <p><a href="tel:0034623300623">623 30 06 23</a></p>
                    <a
                      href="https://www.grupodunna.es/alojamiento/hostal-atalaya/"
                      >🌐 Web</a
                    >
                    <a target="_blank" href="https://maps.app.goo.gl/UHj2FdHZnCDLGN3EA">📍 Mapa</a>
                  </div>
                </div>
              </li>
              <li class="flex effect-opacity gap-1.5">
                <div
                  class="!w-[100px] image-wrapper aspect-square overflow-hidden rounded-md"
                >
                  <img src="/fairplay.jpeg" />
                </div>
                <div class="w-full flex flex-col items-start">
                  <h4>Fairplay Golf & Spa Resort</h4>
                  <div class="flex flex-wrap gap-2.5">
                    <p><a href="tel:0034956424824">956 42 48 24</a></p>
                    <a href="https://www.fairplayresort.es/">🌐 Web</a>
                    <a target="_blank" href="https://maps.app.goo.gl/Sk4nJFjZqSiuSYuq6">📍 Mapa</a>
                  </div>
                </div>
              </li>
            </ul>
            <div class="my-12">
              <p class="text-xs">
                Te recomendamos que reserves con antelación,<br> ya que el hotel
                puede estar completo.
              </p>
              <p class="text-xs">
                Si necesitas ayuda, no dudes en contactarnos.
              </p>
            </div>
		</section>
		 <section class="relative">
			<img src="/flower5.jpg" class="flower-5" />
		</section>
          <section class="mb-32 effect-opacity">
            <h3>Regalo</h3>
            <p>
              El mayor regalo que podéis hacernos es estar con vuestra presencia
              y compartir con nosotros la alegría
            </p>
            <p>
              Si, además, quieres ayudarnos para darnos un capricho, te dejamos
              nuestro número de cuenta:
            </p>
            <code class="text-green">ES76 2100 1234 5678 0012 3456</code>
          </section>
		 
          <section class="mb-32 effect-opacity">
            <h3>Álbum de fotos</h3>
            <p>
              ¡Hemos creado un álbum digital donde nos gustaría que nos pasaras
              las fotos después de la ceremonia!
            </p>

            <div class="flex justify-center">
              <img class="w-36 mix-blend-multiply" src="/qr.jpg" />
            </div>
          </section>
          <section class="mb-32 effect-opacity  flex flex-col gap-4 justify-center items-center">
            <h3>¡Os esperamos! ❤️</h3>
			<div class="cta !mb-0">Confirmar asistencia</div>

          </section>
        </section>
      </div>
    </div>
    <form id="contact-form">
		<p class="close-form absolute top-0 right-0 p-7">Cerrar</p>
      <fieldset>
        <legend class="!mb-3">¿Vas a asistir?</legend>
		<p class="mb-4">Puedes añadir acompañante/s debajo</p>
        <section class="flex gap-4">
          <div>
            <input type="radio" id="si-1" name="service" value="Sí" required />
            <label for="si-1">Sí</label>
          </div>
          <div>
            <input type="radio" id="no-1" name="service" value="No" required />
            <label for="no-1">No</label>
          </div>
        </section>
      </fieldset>

      <div>
        <label for="email">Email*</label>
        <input id="email" type="email" name="email" required />
      </div>

      <div id="personas-wrapper">
        <div class="persona">
          <div class="flex justify-between items-center mb-2">
            <label for="name-1">Nombre*</label>
          </div>
          <input id="name-1" name="name-1" type="text" required />

          <label for="message-1">Alergías o preferencias alimentarias</label>
          <textarea id="message-1" name="message-1"></textarea>
        </div>
      </div>

      <button type="button" id="add-persona" class="my-4"
        >Añadir otra persona</button
      >

      <div class="button-wrapper">
        <button type="submit">Enviar</button>
      </div>
    </form>

    <script>
      import gsap from "gsap";
      import { ScrollTrigger } from "gsap/ScrollTrigger";
      gsap.registerPlugin(ScrollTrigger);

      // Animación intro
      const tl = gsap.timeline({ delay: 0.5 });

      const back = document.querySelector(".flower-1");
      const nameIntro = document.querySelector(".intro-names");
      const intro = document.querySelector(".introduction-text");
      const envelopeGroup = document.querySelector(".envelope-group");
      const envelopeGroupClosed = document.querySelector(
        ".envelope-group .sobre-close"
      );
      const envelopeGroupOpened = document.querySelector(
        ".envelope-group .sobre-open"
      );

      const content = document.querySelector(".content");

      gsap.set(envelopeGroup, {
        xPercent: -150,
        rotate: 180,
      });

      gsap.set(back, {
        autoAlpha: 0,
      });

      gsap.set(intro, {
        yPercent: -350,
      });

      gsap.set(content, {
        yPercent: 100,
      });

      tl.to(back, {
        autoAlpha: 0.07,
        duration: 1,
        ease: "power2.inOut",
      })
        .to(
          nameIntro,
          {
            autoAlpha: 1,
            duration: 1,
            ease: "power2.inOut",
          },
          "<"
        )
        .to(intro, {
          autoAlpha: 1,
          duration: 1,
          ease: "power2.inOut",
        })
        .to(intro, {
          delay: 1,
          autoAlpha: 1,
          yPercent: 0,
          duration: 0.5,
          ease: "power2.inOut",
        })
        .to(
          envelopeGroup,
          {
            xPercent: 0,
            rotate: 0,
            duration: 1,
            ease: "power2.inOut",
            onComplete: () => {
              envelopeGroup?.classList.add("pointer-events-auto");
              openEnvelope();
              const tlPulse = gsap.timeline({
                repeat: -1,
                yoyo: true,
                delay: 0.5,
              });
              tlPulse.to(envelopeGroupClosed, {
                scale: 1.05,
                duration: 0.5,
                rotate: 5,
                yPercent: -4,
                xPercent: 2,
              });
            },
          },
          "<"
        );

      function openEnvelope() {
        console.log("click");
        envelopeGroup?.addEventListener("click", () => {
          envelopeGroupClosed?.classList.add("hidden");
          envelopeGroupOpened?.classList.add("block");

          const imageTwo = document.querySelector(".image-two");

          const tlOutEnvelope = gsap.timeline({
            delay: 0.5,
          });

          tlOutEnvelope
            .to(
              intro,
              {
                autoAlpha: 0,
              },
              "<"
            )
            .to(
              nameIntro,
              {
                autoAlpha: 0,
              },
              "<"
            )
            .to(
              envelopeGroupOpened,
              {
                yPercent: 300,
                rotate: -25,
                duration: 1,
                ease: "power2.inOut",
              },
              "<"
            )
            .to(
              content,
              {
                autoAlpha: 1,
              },
              "<"
            )
            .to(
              content,
              {
                yPercent: 0,
                duration: 1,
              },
              "<"
            )
            .to(imageTwo, {
              rotate: -5,
              duration: 1,
              ease: "power2.inOut",
            });
        });
      }

      const elems = document.querySelectorAll(".effect-opacity");

      elems.forEach((el) => {
        gsap.set(el, {
          autoAlpha: 0,
          yPercent: 10,
        });

        gsap.to(el, {
          autoAlpha: 1,
          duration: 1,
          yPercent: 0,
          scrollTrigger: {
            scroller: ".content",
            trigger: el,
            start: "top bottom",
            end: "center center",
            scrub: 1,
            toggleActions: "play none none none",
          },
        });
      });

    const cta = document.querySelectorAll(".cta");

    //   gsap.to(cta, {
    //     scrollTrigger: {
    //       scroller: ".content",
    //       trigger: cta,
    //       endTrigger: ".content-wrapper",
    //       pin: true,
    //       pinSpacing: false,
    //       start: "bottom bottom",
    //       end: "bottom bottom",
    //     },
    //   });

	  const form = document.querySelector("#contact-form");
	  const close = document.querySelector(".close-form");

	 gsap.set(form, {
		yPercent: 100,
	});

	function openForm() {	
		cta?.forEach((el) => {
			el.addEventListener("click", () => {
				gsap.to(form, {
					yPercent: 0,
					duration: 1,
					ease: "power2.inOut",
				});
			});
		});
		
	}	

	function closeForm() {	
		close?.addEventListener("click", () => {
			gsap.to(form, {
				yPercent: 100,
				duration: 1,
				ease: "power2.inOut",
			});
		});
	}	

	openForm();
	closeForm();
    </script>

    <script type="module">
      let personaCount = 1;
      const wrapper = document.getElementById("personas-wrapper");
      const addBtn = document.getElementById("add-persona");

      function addRemoveListener(button) {
        button.addEventListener("click", () => {
          const persona = button.closest(".persona");
          if (wrapper.children.length > 1) {
            persona.remove();
            renumerarCampos();
          } else {
            alert("Debe haber al menos una persona.");
          }
        });
      }

      function renumerarCampos() {
        document.querySelectorAll(".persona").forEach((div, index) => {
          const i = index + 1;
          div.querySelectorAll("input, textarea, label").forEach((el) => {
            if (el.tagName === "LABEL")
              el.htmlFor = el.htmlFor?.replace(/\d+$/, "") + i;
            if (el.name) el.name = el.name.replace(/\d+$/, "") + i;
            if (el.id) el.id = el.id.replace(/\d+$/, "") + i;
          });
        });
        personaCount = wrapper.children.length;
      }

      addBtn.addEventListener("click", () => {
        personaCount++;
        const last = wrapper.querySelector(".persona:last-of-type");
        const clone = last.cloneNode(true);

        // Limpiar campos
        clone
          .querySelectorAll("input, textarea")
          .forEach((el) => (el.value = ""));

        // Añadir botón "Quitar" si no existe
        let labelWrapper = clone.querySelector(".flex");
        if (!labelWrapper) {
          // Crear encabezado de campo si no existe
          labelWrapper = document.createElement("div");
          labelWrapper.className = "flex justify-between items-center mb-2";
          const nameLabel = document.createElement("label");
          nameLabel.textContent = "Nombre*";
          nameLabel.setAttribute("for", `name-${personaCount}`);
          labelWrapper.appendChild(nameLabel);
          clone.insertBefore(labelWrapper, clone.firstChild);
        }

        // Quitar cualquier botón previo
        clone.querySelector(".remove-persona")?.remove();

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "remove-persona text-red-600 text-sm";
        removeBtn.textContent = "Quitar";
        labelWrapper.appendChild(removeBtn);
        addRemoveListener(removeBtn);

        wrapper.appendChild(clone);
        renumerarCampos();
      });
    </script>

    <script type="module">
      const form = document.getElementById("contact-form");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const personas = [];

        // Recorre cada bloque de persona (solo nombre + alergias)
        document.querySelectorAll(".persona").forEach((personaDiv, index) => {
          const name =
            personaDiv.querySelector(`[name="name-${index + 1}"]`)?.value || "";
          const message =
            personaDiv.querySelector(`[name="message-${index + 1}"]`)?.value ||
            "";

          personas.push({ name, message });
        });

        // Email y asistencia (únicos)
        const email = document.querySelector('[name="email"]')?.value || "";
        const asistencia =
          document.querySelector('[name="service"]:checked')?.value || "";

        const res = await fetch(`/api/send-mail`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email,
            asistencia,
            personas,
          }),
        });

        if (res.ok) {
          alert("¡Correo enviado!");
          form.reset();
        } else {
          const err = await res.json();
          alert("Error al enviar: " + err.error);
        }
      });
    </script>
  </div>

  <style></style>
</Layout>
